// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum NotificationChannel {
  EMAIL
  IN_APP
}

enum NotificationSeverity {
  INFO
  SECURITY
  LEGAL
}

enum NotificationStatus {
  QUEUED
  SENT
  DELIVERED
  FAILED
  SKIPPED
}

enum NotificationActorType {
  USER
  SYSTEM
  ADMIN
}

model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  role      String    @default("CUSTOMER")
  emailVerified Boolean @default(false)
  passwordChangedAt DateTime?
  emailPending String?
  emailPendingRequestedAt DateTime?
  passwordPendingHash String?
  passwordPendingRequestedAt DateTime?
  sessionsRevokedAt DateTime?
  totpEnabled Boolean @default(false)
  totpSecret String?
  totpRecoveryId String? @unique
  totpBackupCodes String @default("[]")
  totpBackupCodesUpdatedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  customer  Customer?
  notificationPreferences NotificationPreferences?
  notificationLogs NotificationLog[]
  devices   UserDevice[]
  sessions  UserSession[]
  consents  UserConsent[]
  errorEvents ErrorEvent[]
}

model UserDevice {
  id           Int      @id @default(autoincrement())
  userId       Int
  deviceId     String
  lastIpPrefix String?
  lastUserAgent String?
  lastSeenAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@index([userId])
}

model UserSession {
  id            Int      @id @default(autoincrement())
  userId        Int
  sessionId     String
  ip            String?
  ipPrefix      String?
  userAgent     String?
  city          String?
  region        String?
  country       String?
  locationLabel String?
  latitude      Float?
  longitude     Float?
  lastSeenAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  revokedAt     DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
  @@index([userId])
}

model NotificationPreferences {
  id                          Int      @id @default(autoincrement())
  userId                      Int      @unique
  emailProfileUpdatesEnabled  Boolean  @default(false)
  emailFeatureUpdatesEnabled  Boolean  @default(true)
  emailMarketingEnabled       Boolean  @default(false)
  preferencesVersion          Int?
  updatedByUserId             Int?
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Customer {
  id               Int       @id @default(autoincrement())
  userId           Int       @unique
  name             String
  preferredLangs   String
  priorInsurance   String
  coverages        String
  isDisabled       Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  drivers          Driver[]
  vehicles         Vehicle[]
  profileData      String    @default("{}")
  shares           ProfileShare[]
  questions        QuestionBank[]
  customerQuestions CustomerQuestion[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfileShare {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  codeHash  String
  sections  String   @default("{}")
  snapshot  String   @default("{}")
  editable  Boolean  @default(false)
  status    String   @default("active")
  pendingEdits  String   @default("{}")
  pendingStatus String  @default("none")
  pendingAt DateTime?
  recipientName String?
  recipientNameNormalized String?
  lastAccessedAt DateTime?
  customerId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model Driver {
  id           Int      @id @default(autoincrement())
  customerId   Int
  name         String
  licenseNo    String
  birthDate    DateTime
  relationship String

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model Vehicle {
  id         Int    @id @default(autoincrement())
  customerId Int
  year       Int
  make       String
  model      String
  vin        String
  primaryUse String

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model AdminUser {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  password   String
  role       String   @default("ADMIN")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  auditLogs  AuditLog[]
}

model AuditLog {
  id        Int       @id @default(autoincrement())
  actorId   Int?
  actor     AdminUser? @relation(fields: [actorId], references: [id], onDelete: Cascade)
  targetType String
  targetId   String
  action     String
  diff       String?
  createdAt  DateTime  @default(now())
}

model NotificationLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  channel   NotificationChannel
  eventType String
  severity  NotificationSeverity
  userId    Int?
  recipientEmail String?
  recipientUserAgentHash String?
  subject   String?
  provider  String?
  providerMessageId String? @unique
  status    NotificationStatus
  failureReason String?
  required  Boolean @default(true)
  preferenceSnapshot Json?
  metadata  Json?
  actorType NotificationActorType @default(SYSTEM)
  actorUserId Int?
  correlationId String?
  dedupeKey String?
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([status, createdAt])
}

model ErrorEvent {
  id             Int      @id @default(autoincrement())
  createdAt      DateTime @default(now())
  level          String   @default("error")
  source         String   @default("frontend")
  message        String
  stack          String?
  url            String?
  userAgent      String?
  componentStack String?
  release        String?
  sessionId      String?
  fingerprint    String?
  metadata       String?
  userId         Int?
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([level])
  @@index([source])
  @@index([userId])
}

model SiteContent {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  title       String
  content     String
  updatedBy   String?
  lastUpdated DateTime @default(now())
}

model Product {
  id        Int          @id @default(autoincrement())
  name      String       @unique
  slug      String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  questions QuestionBank[]
  customerQuestions CustomerQuestion[]
}

model FormSchema {
  id        Int      @id @default(autoincrement())
  slug      String   @unique
  schema    String
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QuestionSource {
  SYSTEM
  CUSTOMER
}

model QuestionBank {
  id         Int            @id @default(autoincrement())
  text       String
  normalized String         @unique
  sortOrder  Int?
  source     QuestionSource @default(SYSTEM)
  inputType  String         @default("general")
  selectOptions String      @default("[]")
  productId  Int?
  customerId Int?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  product    Product?       @relation(fields: [productId], references: [id], onDelete: SetNull)
  customer   Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([source])
  @@index([productId])
  @@index([customerId])
}

model CustomerQuestion {
  id         Int      @id @default(autoincrement())
  text       String
  normalized String
  formName   String
  productId  Int?
  customerId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([productId])
  @@index([formName])
  @@index([normalized])
  @@unique([customerId, productId, formName, normalized])
}

model EmailOtp {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  code       String
  codeHash   String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  attempts   Int      @default(0)
  lastSentAt DateTime?
  lastSentIp String?
}

model EmailOtpRequest {
  id        Int      @id @default(autoincrement())
  email     String
  ip        String?
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ip, createdAt])
}

model LegalDocument {
  id          Int      @id @default(autoincrement())
  type        String
  version     String
  contentHash String
  content     String
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([type, version])
  @@index([type, publishedAt])
}

model UserConsent {
  id           Int      @id @default(autoincrement())
  userId       Int
  role         String
  documentType String
  version      String
  ipAddress    String?
  userAgent    String?
  consentedAt  DateTime @default(now())
  consentItems String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentType, version])
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  role      String    @default("CUSTOMER")
  emailVerified Boolean @default(false)
  totpEnabled Boolean @default(false)
  totpSecret String?
  totpRecoveryId String? @unique
  totpBackupCodes String @default("[]")
  totpBackupCodesUpdatedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  agent     Agent?
  customer  Customer?
}

model Agent {
  id           Int        @id @default(autoincrement())
  userId       Int        @unique
  name         String
  bio          String
  photo        String
  languages    String
  states       String
  specialty    String
  producerNumber String?
  address        String?
  zip            String?
  phone          String?
  products       String   @default("[]")
  appointedCarriers String @default("[]")
  status        String    @default("approved")
  isSuspended   Boolean   @default(false)
  underReview   Boolean   @default(false)
  availability String
  rating       Float
  reviews      String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  messages     Message[]  @relation("AgentMessages")
  shares       ProfileShare[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Customer {
  id               Int       @id @default(autoincrement())
  userId           Int       @unique
  name             String
  preferredLangs   String
  priorInsurance   String
  coverages        String
  isDisabled       Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  drivers          Driver[]
  vehicles         Vehicle[]
  profileData      String    @default("{}")
  messages         Message[] @relation("CustomerMessages")
  shares           ProfileShare[]
  questions        QuestionBank[]
  customerQuestions CustomerQuestion[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfileShare {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  codeHash  String
  sections  String   @default("{}")
  snapshot  String   @default("{}")
  editable  Boolean  @default(false)
  status    String   @default("active")
  pendingEdits  String   @default("{}")
  pendingStatus String  @default("none")
  pendingAt DateTime?
  recipientName String?
  recipientNameNormalized String?
  lastAccessedAt DateTime?
  customerId Int
  agentId   Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  agent    Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)
}

model Message {
  id         Int      @id @default(autoincrement())
  agentId    Int
  customerId Int
  body       String
  senderRole String   @default("CUSTOMER")
  createdAt  DateTime @default(now())

  agent    Agent    @relation("AgentMessages", fields: [agentId], references: [id], onDelete: Cascade)
  customer Customer @relation("CustomerMessages", fields: [customerId], references: [id], onDelete: Cascade)
}

model Driver {
  id           Int      @id @default(autoincrement())
  customerId   Int
  name         String
  licenseNo    String
  birthDate    DateTime
  relationship String

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model Vehicle {
  id         Int    @id @default(autoincrement())
  customerId Int
  year       Int
  make       String
  model      String
  vin        String
  primaryUse String

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model AdminUser {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  password   String
  role       String   @default("ADMIN")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  auditLogs  AuditLog[]
}

model AuditLog {
  id        Int       @id @default(autoincrement())
  actorId   Int?
  actor     AdminUser? @relation(fields: [actorId], references: [id], onDelete: Cascade)
  targetType String
  targetId   String
  action     String
  diff       String?
  createdAt  DateTime  @default(now())
}

model SiteContent {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  title       String
  content     String
  updatedBy   String?
  lastUpdated DateTime @default(now())
}

model Product {
  id        Int          @id @default(autoincrement())
  name      String       @unique
  slug      String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  questions QuestionBank[]
  customerQuestions CustomerQuestion[]
}

model FormSchema {
  id        Int      @id @default(autoincrement())
  slug      String   @unique
  schema    String
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QuestionSource {
  SYSTEM
  CUSTOMER
}

model QuestionBank {
  id         Int            @id @default(autoincrement())
  text       String
  normalized String         @unique
  source     QuestionSource @default(SYSTEM)
  productId  Int?
  customerId Int?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  product    Product?       @relation(fields: [productId], references: [id], onDelete: SetNull)
  customer   Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([source])
  @@index([productId])
  @@index([customerId])
}

model CustomerQuestion {
  id         Int      @id @default(autoincrement())
  text       String
  normalized String
  formName   String
  productId  Int?
  customerId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([productId])
  @@index([formName])
  @@index([normalized])
  @@unique([customerId, productId, formName, normalized])
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  role      String    @default("CUSTOMER")
  emailVerified Boolean @default(false)
  passwordChangedAt DateTime?
  emailPending String?
  emailPendingRequestedAt DateTime?
  passwordPendingHash String?
  passwordPendingRequestedAt DateTime?
  sessionsRevokedAt DateTime?
  totpEnabled Boolean @default(false)
  totpSecret String?
  totpRecoveryId String? @unique
  totpBackupCodes String @default("[]")
  totpBackupCodesUpdatedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  agent     Agent?
  customer  Customer?
  consents  UserConsent[]
  readStates ReadState[]
  errorEvents ErrorEvent[]
}

model Agent {
  id           Int        @id @default(autoincrement())
  userId       Int        @unique
  name         String
  bio          String
  photo        String
  languages    String
  states       String
  specialty    String
  producerNumber String?
  address        String?
  zip            String?
  phone          String?
  products       String   @default("[]")
  appointedCarriers String @default("[]")
  status        String    @default("approved")
  isSuspended   Boolean   @default(false)
  underReview   Boolean   @default(false)
  availability String
  rating       Float
  reviews      String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  conversations Conversation[] @relation("AgentConversations")
  shares       ProfileShare[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Customer {
  id               Int       @id @default(autoincrement())
  userId           Int       @unique
  name             String
  preferredLangs   String
  priorInsurance   String
  coverages        String
  isDisabled       Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  drivers          Driver[]
  vehicles         Vehicle[]
  profileData      String    @default("{}")
  conversations    Conversation[] @relation("ClientConversations")
  shares           ProfileShare[]
  questions        QuestionBank[]
  customerQuestions CustomerQuestion[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfileShare {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  codeHash  String
  sections  String   @default("{}")
  snapshot  String   @default("{}")
  editable  Boolean  @default(false)
  status    String   @default("active")
  pendingEdits  String   @default("{}")
  pendingStatus String  @default("none")
  pendingAt DateTime?
  recipientName String?
  recipientNameNormalized String?
  lastAccessedAt DateTime?
  customerId Int
  agentId   Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  agent    Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)
}

model Conversation {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clientId  Int
  agentId   Int

  client     Customer   @relation("ClientConversations", fields: [clientId], references: [id], onDelete: Cascade)
  agent      Agent      @relation("AgentConversations", fields: [agentId], references: [id], onDelete: Cascade)
  messages   Message[]
  readStates ReadState[]

  @@unique([clientId, agentId])
  @@index([agentId])
  @@index([clientId])
}

model Message {
  id             Int      @id @default(autoincrement())
  conversationId Int
  senderId       Int
  body           String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model ReadState {
  conversationId Int
  userId         Int
  lastReadAt     DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
  @@index([userId])
}

model Driver {
  id           Int      @id @default(autoincrement())
  customerId   Int
  name         String
  licenseNo    String
  birthDate    DateTime
  relationship String

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model Vehicle {
  id         Int    @id @default(autoincrement())
  customerId Int
  year       Int
  make       String
  model      String
  vin        String
  primaryUse String

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model AdminUser {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  password   String
  role       String   @default("ADMIN")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  auditLogs  AuditLog[]
}

model AuditLog {
  id        Int       @id @default(autoincrement())
  actorId   Int?
  actor     AdminUser? @relation(fields: [actorId], references: [id], onDelete: Cascade)
  targetType String
  targetId   String
  action     String
  diff       String?
  createdAt  DateTime  @default(now())
}

model ErrorEvent {
  id             Int      @id @default(autoincrement())
  createdAt      DateTime @default(now())
  level          String   @default("error")
  source         String   @default("frontend")
  message        String
  stack          String?
  url            String?
  userAgent      String?
  componentStack String?
  release        String?
  sessionId      String?
  fingerprint    String?
  metadata       String?
  userId         Int?
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([level])
  @@index([source])
  @@index([userId])
}

model SiteContent {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  title       String
  content     String
  updatedBy   String?
  lastUpdated DateTime @default(now())
}

model Product {
  id        Int          @id @default(autoincrement())
  name      String       @unique
  slug      String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  questions QuestionBank[]
  customerQuestions CustomerQuestion[]
}

model FormSchema {
  id        Int      @id @default(autoincrement())
  slug      String   @unique
  schema    String
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QuestionSource {
  SYSTEM
  CUSTOMER
}

model QuestionBank {
  id         Int            @id @default(autoincrement())
  text       String
  normalized String         @unique
  sortOrder  Int?
  source     QuestionSource @default(SYSTEM)
  inputType  String         @default("general")
  selectOptions String      @default("[]")
  productId  Int?
  customerId Int?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  product    Product?       @relation(fields: [productId], references: [id], onDelete: SetNull)
  customer   Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([source])
  @@index([productId])
  @@index([customerId])
}

model CustomerQuestion {
  id         Int      @id @default(autoincrement())
  text       String
  normalized String
  formName   String
  productId  Int?
  customerId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([productId])
  @@index([formName])
  @@index([normalized])
  @@unique([customerId, productId, formName, normalized])
}

model EmailOtp {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  code       String
  codeHash   String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  attempts   Int      @default(0)
  lastSentAt DateTime?
  lastSentIp String?
}

model EmailOtpRequest {
  id        Int      @id @default(autoincrement())
  email     String
  ip        String?
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ip, createdAt])
}

model LegalDocument {
  id          Int      @id @default(autoincrement())
  type        String
  version     String
  contentHash String
  content     String
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([type, version])
  @@index([type, publishedAt])
}

model UserConsent {
  id           Int      @id @default(autoincrement())
  userId       Int
  role         String
  documentType String
  version      String
  ipAddress    String?
  userAgent    String?
  consentedAt  DateTime @default(now())
  consentItems String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentType, version])
}

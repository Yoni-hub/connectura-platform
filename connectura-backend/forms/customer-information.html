<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Connectura Form System</title>
  <style>
    :root {
      --page-bg: #f8f4e8;
      --panel-bg: #fdfcf8;
      --border: #b7b2a4;
      --label: #222;
      --accent: #6b6257;
      --nav-active: #d9d2c3;
      --btn: #c6b9a2;
      --btn-text: #1f1b17;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--page-bg);
      color: var(--label);
      font-family: "Segoe UI", Tahoma, sans-serif;
    }
    .page {
      max-width: 1400px;
      width: 100%;
      margin: 16px auto;
      padding: 16px 18px 30px;
      background: var(--panel-bg);
      border: 1px solid var(--border);
    }
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }
    label {
      font-weight: 600;
      color: var(--accent);
      white-space: nowrap;
    }
    select {
      height: 34px;
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid var(--border);
      background: var(--page-bg);
      min-width: 240px;
    }
    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      column-gap: 18px;
      align-items: start;
    }
    .step-list {
      border: 1px solid var(--border);
      background: var(--panel-bg);
      padding: 12px 10px;
      list-style: none;
      margin: 0;
      min-height: 760px;
    }
    .step-list li {
      padding: 10px 12px;
      border-left: 4px solid transparent;
      cursor: pointer;
      color: var(--accent);
      font-weight: 600;
    }
    .step-list li.active {
      background: var(--nav-active);
      border-color: #b09a7a;
    }
    .content-shell {
      border: 1px solid var(--border);
      background: var(--panel-bg);
      min-height: 760px;
      display: flex;
      flex-direction: column;
    }
    .step-content {
      padding: 14px 16px 18px;
      flex: 1;
      overflow: auto;
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 10px;
      border-top: 1px solid var(--border);
      background: var(--panel-bg);
    }
    .btn {
      border: 1px solid #9f9380;
      background: var(--btn);
      color: var(--btn-text);
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      min-width: 90px;
      text-align: center;
    }
    .other-input {
      display: none;
      width: auto;
      min-width: 240px;
      max-width: 100%;
      padding: 6px 10px;
      height: 34px;
      border: 1px solid var(--border);
      background: var(--page-bg);
      font-size: 14px;
      box-sizing: border-box;
    }
    .extra-card {
      margin-top: 14px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .extra-card textarea {
      width: 100%;
      min-height: 90px;
      padding: 8px;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      font-size: 14px;
      resize: vertical;
    }
    .upload-btn {
      display: inline-block;
      border: 1px solid #9f9380;
      background: var(--btn);
      color: var(--btn-text);
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }
    .upload-input {
      display: none;
    }
    .placeholder {
      color: #6f6457;
      font-size: 15px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <label for="productSelect">Select Insurance Product:</label>
      <select id="productSelect">
        <option value="personal-auto" selected>Personal Auto</option>
        <option value="homeowners">Homeowners</option>
        <option value="renters">Renters</option>
        <option value="motorcycle-offroad">Motorcycle / Off-Road</option>
        <option value="commercial-auto">Commercial Auto</option>
        <option value="general-liability">General Liability Insurance</option>
        <option value="commercial-property">Commercial Property Insurance</option>
        <option value="workers-comp">Workers' Compensation</option>
        <option value="professional-liability">Professional Liability (Errors & Omissions)</option>
        <option value="umbrella">Umbrella Insurance</option>
        <option value="travel">Travel Insurance</option>
        <option value="pet">Pet Insurance</option>
        <option value="flood-earthquake">Flood or Earthquake Insurance</option>
        <option value="health">Health Insurance</option>
        <option value="life">Life Insurance</option>
        <option value="disability">Disability Insurance</option>
        <option value="dental-vision">Dental & Vision Insurance</option>
        <option value="long-term-care">Long-Term Care Insurance</option>
        <option value="cyber-liability">Cyber Liability Insurance</option>
      </select>
    </div>

    <div class="layout">
      <ol class="step-list" id="stepNav"></ol>
      <div class="content-shell">
        <div class="step-content" id="stepContent">
          <div class="placeholder">Loading...</div>
        </div>
        <div class="actions">
          <button type="button" class="btn" id="prevBtn">Previous</button>
          <button type="button" class="btn" id="nextBtn">Next</button>
          <button type="button" class="btn" id="saveBtn">Save</button>
          <button type="button" class="btn" id="shareBtn">Share</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const cacheBust = Date.now();
    const defaultButtons = { prev: 'Previous', next: 'Next', save: 'Save', share: 'Share' };

    function buildProductConfig(steps, customButtons) {
      const buttons = customButtons || defaultButtons;
      const visibleByStep = {};
      steps.forEach((_, idx) => {
        const stepNum = idx + 1;
        visibleByStep[stepNum] = {
          prev: stepNum > 1,
          next: stepNum < steps.length,
          save: true,
          share: stepNum === steps.length,
        };
      });
      return { steps, buttons, visibleByStep };
    }

    let selectObserver = null;
    const productConfigs = {
      'personal-auto': buildProductConfig([
        { title: 'Named Insured', file: 'products/personal-auto/steps/step1.html' },
        { title: 'Current Mailing Address', file: 'products/personal-auto/steps/step2.html' },
        { title: 'Driver Information', file: 'products/personal-auto/steps/step3.html' },
        { title: 'Vehicle Information', file: 'products/personal-auto/steps/step4.html' },
        { title: 'Coverages', file: 'products/personal-auto/steps/step5.html' },
        { title: 'Prior Policy Information', file: 'products/personal-auto/steps/step6.html' },
        { title: 'Additional Information', file: 'products/personal-auto/steps/step7.html' },
      ]),
      homeowners: buildProductConfig([
        { title: 'Property & Insured', file: 'products/homeowners/steps/step1.html' },
        { title: 'Coverages', file: 'products/homeowners/steps/step2.html' },
        { title: 'Loss History', file: 'products/homeowners/steps/step3.html' },
      ]),
      renters: buildProductConfig([
        { title: 'Applicant & Address', file: 'products/renters/steps/step1.html' },
        { title: 'Contents Coverage', file: 'products/renters/steps/step2.html' },
      ]),
      'motorcycle-offroad': buildProductConfig([
        { title: 'Applicant & Contact', file: 'products/motorcycle-offroad/steps/step1.html' },
        { title: 'Motorcycle / Off-Road Unit', file: 'products/motorcycle-offroad/steps/step2.html' },
        { title: 'Coverages & History', file: 'products/motorcycle-offroad/steps/step3.html' },
      ]),
      'commercial-auto': buildProductConfig([
        { title: 'Business & Operations', file: 'products/commercial-auto/steps/step1.html' },
        { title: 'Vehicle Schedule', file: 'products/commercial-auto/steps/step2.html' },
        { title: 'Drivers', file: 'products/commercial-auto/steps/step3.html' },
        { title: 'Coverages & Loss History', file: 'products/commercial-auto/steps/step4.html' },
      ]),
      'general-liability': buildProductConfig([
        { title: 'Business & Operations', file: 'products/general-liability/steps/step1.html' },
        { title: 'Coverages & Limits', file: 'products/general-liability/steps/step2.html' },
        { title: 'Risk Controls & Loss History', file: 'products/general-liability/steps/step3.html' },
      ]),
      'commercial-property': buildProductConfig([
        { title: 'Location & Building Details', file: 'products/commercial-property/steps/step1.html' },
        { title: 'Protections & Exposure', file: 'products/commercial-property/steps/step2.html' },
        { title: 'Coverages & Valuation', file: 'products/commercial-property/steps/step3.html' },
      ]),
      'workers-comp': buildProductConfig([
        { title: 'Employer Information', file: 'products/workers-comp/steps/step1.html' },
        { title: 'Exposure & Payroll', file: 'products/workers-comp/steps/step2.html' },
        { title: 'Safety & Loss History', file: 'products/workers-comp/steps/step3.html' },
      ]),
      'professional-liability': buildProductConfig([
        { title: 'Firm Profile', file: 'products/professional-liability/steps/step1.html' },
        { title: 'Coverage Details', file: 'products/professional-liability/steps/step2.html' },
        { title: 'Claims & Risk Controls', file: 'products/professional-liability/steps/step3.html' },
      ]),
      umbrella: buildProductConfig([
        { title: 'Underlying Policies', file: 'products/umbrella/steps/step1.html' },
        { title: 'Exposure Summary', file: 'products/umbrella/steps/step2.html' },
        { title: 'Umbrella Coverage & Loss History', file: 'products/umbrella/steps/step3.html' },
      ]),
      travel: buildProductConfig([
        { title: 'Trip Details', file: 'products/travel/steps/step1.html' },
        { title: 'Traveler Information', file: 'products/travel/steps/step2.html' },
        { title: 'Coverage Selections', file: 'products/travel/steps/step3.html' },
      ]),
      pet: buildProductConfig([
        { title: 'Owner & Pet Details', file: 'products/pet/steps/step1.html' },
        { title: 'Health & Coverage', file: 'products/pet/steps/step2.html' },
      ]),
      'flood-earthquake': buildProductConfig([
        { title: 'Property Location', file: 'products/flood-earthquake/steps/step1.html' },
        { title: 'Building Details', file: 'products/flood-earthquake/steps/step2.html' },
        { title: 'Coverage & History', file: 'products/flood-earthquake/steps/step3.html' },
      ]),
      health: buildProductConfig([
        { title: 'Household Information', file: 'products/health/steps/step1.html' },
        { title: 'Coverage Preferences', file: 'products/health/steps/step2.html' },
        { title: 'Disclosures', file: 'products/health/steps/step3.html' },
      ]),
      life: buildProductConfig([
        { title: 'Proposed Insured', file: 'products/life/steps/step1.html' },
        { title: 'Coverage & Beneficiaries', file: 'products/life/steps/step2.html' },
        { title: 'Health & Lifestyle', file: 'products/life/steps/step3.html' },
      ]),
      disability: buildProductConfig([
        { title: 'Employment & Income', file: 'products/disability/steps/step1.html' },
        { title: 'Benefit Design', file: 'products/disability/steps/step2.html' },
        { title: 'Health & Risks', file: 'products/disability/steps/step3.html' },
      ]),
      'dental-vision': buildProductConfig([
        { title: 'Enrollee & Dependents', file: 'products/dental-vision/steps/step1.html' },
        { title: 'Coverage Elections', file: 'products/dental-vision/steps/step2.html' },
      ]),
      'long-term-care': buildProductConfig([
        { title: 'Applicant Profile', file: 'products/long-term-care/steps/step1.html' },
        { title: 'Coverage Design', file: 'products/long-term-care/steps/step2.html' },
        { title: 'Care Preferences & Health', file: 'products/long-term-care/steps/step3.html' },
      ]),
      'cyber-liability': buildProductConfig([
        { title: 'Organization & Data Profile', file: 'products/cyber-liability/steps/step1.html' },
        { title: 'Security Controls', file: 'products/cyber-liability/steps/step2.html' },
        { title: 'Incidents & Coverage', file: 'products/cyber-liability/steps/step3.html' },
      ]),
    };

    const productSelect = document.getElementById('productSelect');
    const stepNav = document.getElementById('stepNav');
    const stepContent = document.getElementById('stepContent');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const saveBtn = document.getElementById('saveBtn');
    const shareBtn = document.getElementById('shareBtn');

    let currentProduct = 'personal-auto';
    let currentStep = 1;

    function setButtonLabels(cfg) {
      const labels = (cfg && cfg.buttons) || defaultButtons;
      prevBtn.textContent = labels.prev || 'Previous';
      nextBtn.textContent = labels.next || 'Next';
      saveBtn.textContent = labels.save || 'Save';
      shareBtn.textContent = labels.share || 'Share';
    }

    function runInlineScripts(root) {
      const scripts = root.querySelectorAll('script');
      scripts.forEach((old) => {
        const s = document.createElement('script');
        Array.from(old.attributes).forEach((attr) => s.setAttribute(attr.name, attr.value));
        s.textContent = old.textContent;
        old.replaceWith(s);
      });
    }

    function addOtherSupport(select) {
      if (!select || select.dataset.hasOther === '1') return;
      const hasOther = Array.from(select.options).some((opt) => opt.value === 'other' || opt.textContent.trim().toLowerCase() === 'other');
      if (!hasOther) {
        const opt = document.createElement('option');
        opt.value = 'other';
        opt.textContent = 'Other';
        select.appendChild(opt);
      }

      const wrapper = select.closest('.field-control') || select.parentElement;
      const baseId = select.id || select.name || `select-${Math.random().toString(36).slice(2, 7)}`;
      const originalName = select.getAttribute('name') || baseId;
      const inputId = `${baseId}-other`;
      let otherInput = wrapper.querySelector(`[data-other-for="${inputId}"]`);
      if (!otherInput) {
        otherInput = document.createElement('input');
        otherInput.type = 'text';
        otherInput.className = 'other-input';
        otherInput.placeholder = 'Please specify';
        otherInput.id = inputId;
        otherInput.setAttribute('data-other-for', inputId);
        wrapper.appendChild(otherInput);
      }

      function syncOther() {
        const val = (select.value || '').toLowerCase();
        const txt = (select.options[select.selectedIndex]?.textContent || '').trim().toLowerCase();
        const show = val === 'other' || txt === 'other';
        otherInput.style.display = show ? 'block' : 'none';
        select.style.display = show ? 'none' : '';
        if (show) {
          select.name = `${originalName}__select`;
          otherInput.name = originalName;
          if (!otherInput.value) otherInput.focus();
        } else {
          select.name = originalName;
          otherInput.name = '';
          otherInput.value = '';
        }
      }

      otherInput.addEventListener('blur', () => {
        if (!otherInput.value) {
          select.value = '';
          syncOther();
        }
      });
      select.addEventListener('change', syncOther);
      syncOther();
      select.dataset.hasOther = '1';
    }

    function enhanceAllSelects(root) {
      root.querySelectorAll('select').forEach(addOtherSupport);
    }

    function observeSelects() {
      if (selectObserver) selectObserver.disconnect();
      selectObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (!(node instanceof HTMLElement)) return;
            if (node.tagName === 'SELECT') addOtherSupport(node);
            node.querySelectorAll && node.querySelectorAll('select').forEach(addOtherSupport);
          });
        });
      });
      selectObserver.observe(stepContent, { childList: true, subtree: true });
    }

    async function loadStep(step) {
      const cfg = productConfigs[currentProduct];
      if (!cfg) return;
      const stepDef = cfg.steps[step - 1];
      if (!stepDef) return;
      currentStep = step;

      stepNav.querySelectorAll('li').forEach((li) =>
        li.classList.toggle('active', Number(li.dataset.step) === step)
      );

      stepContent.innerHTML = '<div class="placeholder">Loading...</div>';
      try {
        const res = await fetch(`${stepDef.file}?v=${cacheBust}`, { cache: 'no-store' });
        if (!res.ok) throw new Error('Load error');
        const html = await res.text();
        stepContent.innerHTML = html;
        runInlineScripts(stepContent);
        enhanceAllSelects(stepContent);
        observeSelects();

        const uniqueKey = `${currentProduct}-${step}`;
        const missingId = `missing-info-${uniqueKey}`;
        const fileId = `missing-upload-${uniqueKey}`;
        const extra = document.createElement('div');
        extra.className = 'form-card extra-card';
        extra.innerHTML = `
          <div class="card-title">Additional Details</div>
          <div class="form-grid wide">
            <label class="field-label" for="${missingId}">Any missing Information, not included in the form ? Write it here:</label>
            <div class="field-control">
              <textarea id="${missingId}" name="${missingId}" placeholder="Add any extra info here"></textarea>
            </div>
            <label class="field-label" for="${fileId}">Upload File:</label>
            <div class="field-control">
              <label class="upload-btn" for="${fileId}">Upload File</label>
              <input class="upload-input" id="${fileId}" name="${fileId}" type="file" accept="*/*" />
            </div>
          </div>
        `;
        stepContent.appendChild(extra);
      } catch (err) {
        stepContent.innerHTML = '<div class="placeholder">Could not load step.</div>';
      }

      const last = cfg.steps.length;
      const vis = (cfg.visibleByStep && cfg.visibleByStep[step]) || null;
      const showPrev = vis ? !!vis.prev : step > 1;
      const showNext = vis ? !!vis.next : step < last;
      const showSave = vis ? !!vis.save : step === last;
      const showShare = vis ? !!vis.share : step === last;
      prevBtn.style.display = showPrev ? 'inline-block' : 'none';
      nextBtn.style.display = showNext ? 'inline-block' : 'none';
      saveBtn.style.display = showSave ? 'inline-block' : 'none';
      shareBtn.style.display = showShare ? 'inline-block' : 'none';
    }

    function buildNav(cfg) {
      stepNav.innerHTML = '';
      cfg.steps.forEach((step, idx) => {
        const li = document.createElement('li');
        li.dataset.step = idx + 1;
        li.textContent = `${idx + 1}. ${step.title}`;
        li.addEventListener('click', () => loadStep(idx + 1));
        stepNav.appendChild(li);
      });
    }

    function setProduct(productKey) {
      const cfg = productConfigs[productKey];
      currentProduct = productKey;
      if (!cfg) {
        stepNav.innerHTML = '';
        stepContent.innerHTML = '<div class="placeholder">Product not configured yet.</div>';
        prevBtn.style.display = nextBtn.style.display = saveBtn.style.display = shareBtn.style.display = 'none';
        return;
      }
      setButtonLabels(cfg);
      buildNav(cfg);
      loadStep(1);
    }

    productSelect.addEventListener('change', (e) => setProduct(e.target.value));
    prevBtn.addEventListener('click', () => { if (currentStep > 1) loadStep(currentStep - 1); });
    nextBtn.addEventListener('click', () => {
      const cfg = productConfigs[currentProduct];
      if (cfg && currentStep < cfg.steps.length) loadStep(currentStep + 1);
    });
    saveBtn.addEventListener('click', () => alert('Saved'));
    shareBtn.addEventListener('click', () => alert('Shared'));

    setProduct(currentProduct);
  </script>
</body>
</html>
